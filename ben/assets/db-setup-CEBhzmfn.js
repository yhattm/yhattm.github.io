const I=(e,t)=>t.some(n=>e instanceof n);let B,b;function C(){return B||(B=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function x(){return b||(b=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const l=new WeakMap,h=new WeakMap,m=new WeakMap;function j(e){const t=new Promise((n,r)=>{const i=()=>{e.removeEventListener("success",a),e.removeEventListener("error",o)},a=()=>{n(u(e.result)),i()},o=()=>{r(e.error),i()};e.addEventListener("success",a),e.addEventListener("error",o)});return m.set(t,e),t}function O(e){if(l.has(e))return;const t=new Promise((n,r)=>{const i=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",o),e.removeEventListener("abort",o)},a=()=>{n(),i()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",a),e.addEventListener("error",o),e.addEventListener("abort",o)});l.set(e,t)}let D={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return l.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return u(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function S(e){D=e(D)}function v(e){return x().includes(e)?function(...t){return e.apply(g(this),t),u(this.request)}:function(...t){return u(e.apply(g(this),t))}}function V(e){return typeof e=="function"?v(e):(e instanceof IDBTransaction&&O(e),I(e,C())?new Proxy(e,D):e)}function u(e){if(e instanceof IDBRequest)return j(e);if(h.has(e))return h.get(e);const t=V(e);return t!==e&&(h.set(e,t),m.set(t,e)),t}const g=e=>m.get(e);function p(e,t,{blocked:n,upgrade:r,blocking:i,terminated:a}={}){const o=indexedDB.open(e,t),f=u(o);return r&&o.addEventListener("upgradeneeded",s=>{r(u(o.result),s.oldVersion,s.newVersion,u(o.transaction),s)}),n&&o.addEventListener("blocked",s=>n(s.oldVersion,s.newVersion,s)),f.then(s=>{a&&s.addEventListener("close",()=>a()),i&&s.addEventListener("versionchange",c=>i(c.oldVersion,c.newVersion,c))}).catch(()=>{}),f}const A=["get","getKey","getAll","getAllKeys","count"],T=["put","add","delete","clear"],y=new Map;function E(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(y.get(t))return y.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=T.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(i||A.includes(n)))return;const a=async function(o,...f){const s=this.transaction(o,i?"readwrite":"readonly");let c=s.store;return r&&(c=c.index(f.shift())),(await Promise.all([c[n](...f),i&&s.done]))[0]};return y.set(t,a),a}S(e=>({...e,get:(t,n,r)=>E(t,n)||e.get(t,n,r),has:(t,n)=>!!E(t,n)||e.has(t,n)}));const N=["continue","continuePrimaryKey","advance"],P={},w=new WeakMap,L=new WeakMap,k={get(e,t){if(!N.includes(t))return e[t];let n=P[t];return n||(n=P[t]=function(...r){w.set(this,L.get(this)[t](...r))}),n}};async function*W(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,k);for(L.set(n,t),m.set(n,g(t));t;)yield n,t=await(w.get(n)||t.continue()),w.delete(n)}function M(e,t){return t===Symbol.asyncIterator&&I(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&I(e,[IDBIndex,IDBObjectStore])}S(e=>({...e,get(t,n,r){return M(t,n)?W:e.get(t,n,r)},has(t,n){return M(t,n)||e.has(t,n)}}));const F="business-card-scanner",K=1;let d=null;async function R(){return d||(d=await p(F,K,{upgrade(e){e.objectStoreNames.contains("cards")||e.createObjectStore("cards",{keyPath:"id"}).createIndex("by-timestamp","timestamp"),e.objectStoreNames.contains("images")||e.createObjectStore("images",{keyPath:"id"})}}),d)}async function _(){return d||await R()}async function $(){if("storage"in navigator&&"estimate"in navigator.storage){const e=await navigator.storage.estimate(),t=e.usage||0,n=e.quota||0,r=n>0?t/n*100:0;return{usage:t,quota:n,usagePercent:r}}return null}export{_ as getDB,$ as getStorageEstimate,R as initDB};
