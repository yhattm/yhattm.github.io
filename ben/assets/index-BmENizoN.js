import{a as d,B as m}from"./BusinessCard-Di_B8Se3.js";import{C as h}from"./CardImageId-9m3OyPHK.js";import"./Entity-DpinO5cs.js";import"./Result-BKWviScr.js";import"./Identifier-Yjt1Lx6E.js";import"./ValueObject-DRESENkS.js";function l(t){return{id:t.id.value,imageId:t.imageId.value,name:t.name,title:t.title,company:t.company,phone:t.phone,email:t.email,address:t.address,website:t.website,socialMedia:t.contactInfo.socialMedia,fax:t.contactInfo.fax,rawOcr:t.rawOcr,confidence:t.confidence,timestamp:t.timestamp,lastModified:t.lastModified,scanCount:t.scanCount,isComplete:t.isComplete}}function f(t){return t.map(l)}class p{search(r,e){if(!e||e.trim().length===0)return r;const s=e.toLowerCase().trim();return r.filter(a=>this.buildSearchText(a).includes(s))}filterByCompany(r,e){if(!e||e.trim().length===0)return r;const s=e.toLowerCase().trim();return r.filter(a=>(a.company?.toLowerCase()||"").includes(s))}filterWithEmail(r){return r.filter(e=>!!e.email)}filterWithPhone(r){return r.filter(e=>!!e.phone)}filterComplete(r){return r.filter(e=>e.isComplete)}filterIncomplete(r){return r.filter(e=>!e.isComplete)}filterByConfidence(r,e){return r.filter(s=>{const a=s.confidence;switch(e){case"high":return a>=70;case"medium":return a>=50&&a<70;case"low":return a<50}})}buildSearchText(r){const e=[];return r.name&&e.push(r.name),r.company&&e.push(r.company),r.email&&e.push(r.email),r.phone&&e.push(r.phone),r.title&&e.push(r.title),r.address&&e.push(r.address),r.website&&e.push(r.website),e.join(" ").toLowerCase()}}class B{constructor(r,e,s,a){this.cardRepository=r,this.imageRepository=e,this.ocrService=s,this.imageProcessor=a}async execute(r){try{const e=await this.imageProcessor.process(r.imageFile),s=await this.ocrService.recognize(e.compressed,r.onProgress),a=d.create(),o=h.create(),i=m.create({id:a,imageId:o,contactInfo:s.extractedData,scanData:{rawText:s.text,confidence:s.confidence}});if(i.isFailure)return{success:!1,error:i.error.message};const n=i.value,u=await this.imageProcessor.blobToArrayBuffer(e.compressed),c=await this.imageProcessor.blobToArrayBuffer(e.thumbnail);return await this.imageRepository.save({id:o,image:u,thumbnail:c,imageType:"image/jpeg"}),await this.cardRepository.save(n),{success:!0,card:l(n)}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error occurred"}}}}class x{constructor(r){this.cardRepository=r}async execute(){try{const r=await this.cardRepository.findAll();return{success:!0,cards:f(r)}}catch(r){return{success:!1,cards:[],error:r instanceof Error?r.message:"Failed to load cards"}}}}class v{constructor(r){this.cardRepository=r}async execute(r){try{const e=d.from(r.cardId),s=await this.cardRepository.findById(e);if(!s)return{success:!1,error:"Card not found"};const a=s.updateContactInfo(r.updates);return a.isFailure?{success:!1,error:a.error.message}:(await this.cardRepository.save(s),{success:!0,card:l(s)})}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to update card"}}}}class S{constructor(r,e){this.cardRepository=r,this.imageRepository=e}async execute(r){try{const e=d.from(r.cardId),s=await this.cardRepository.findById(e);return s?(await this.imageRepository.delete(s.imageId),await this.cardRepository.delete(e),{success:!0}):{success:!1,error:"Card not found"}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to delete card"}}}}class b{constructor(r,e){this.cardRepository=r,this.imageRepository=e}async execute(r){try{if(r.cardIds.length===0)return{success:!0,deletedCount:0};const e=r.cardIds.map(o=>d.from(o)),a=(await Promise.all(e.map(o=>this.cardRepository.findById(o)))).filter(o=>o!==null).map(o=>o.imageId);return await this.imageRepository.deleteMany(a),await this.cardRepository.deleteMany(e),{success:!0,deletedCount:r.cardIds.length}}catch(e){return{success:!1,deletedCount:0,error:e instanceof Error?e.message:"Failed to delete cards"}}}}class D{constructor(r,e,s,a){this.cardRepository=r,this.imageRepository=e,this.ocrService=s,this.imageProcessor=a}async execute(r){try{const e=d.from(r.cardId),s=await this.cardRepository.findById(e);if(!s)return{success:!1,error:"Card not found"};const a=await this.imageRepository.findById(s.imageId);if(!a)return{success:!1,error:"Card image not found"};const o=this.imageProcessor.arrayBufferToBlob(a.image,a.imageType),i=await this.ocrService.recognize(o,r.onProgress),n=s.rescan(i.text,i.confidence,i.extractedData);return n.isFailure?{success:!1,error:n.error.message}:(await this.cardRepository.save(s),{success:!0,card:l(s)})}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to rescan card"}}}}class P{constructor(r){this.cardRepository=r,this.searchService=new p}searchService;async execute(r){try{let e=await this.cardRepository.findAll();return r.query&&(e=this.searchService.search(e,r.query)),r.filterBy&&(r.filterBy.company&&(e=this.searchService.filterByCompany(e,r.filterBy.company)),r.filterBy.hasEmail&&(e=this.searchService.filterWithEmail(e)),r.filterBy.hasPhone&&(e=this.searchService.filterWithPhone(e)),r.filterBy.isComplete!==void 0&&(e=r.filterBy.isComplete?this.searchService.filterComplete(e):this.searchService.filterIncomplete(e)),r.filterBy.confidenceLevel&&(e=this.searchService.filterByConfidence(e,r.filterBy.confidenceLevel))),{success:!0,cards:f(e),count:e.length}}catch(e){return{success:!1,cards:[],count:0,error:e instanceof Error?e.message:"Failed to search cards"}}}}class T{constructor(r){this.cardRepository=r}async execute(r){try{let e;if(r.cardIds&&r.cardIds.length>0){const n=r.cardIds.map(c=>d.from(c)).map(c=>this.cardRepository.findById(c));e=(await Promise.all(n)).filter(c=>c!==null).map(c=>c)}else e=await this.cardRepository.findAll();const s=f(e),a={exportDate:new Date().toISOString(),cardCount:s.length,cards:s.map(i=>({id:i.id,name:i.name,title:i.title,company:i.company,phone:i.phone,email:i.email,address:i.address,website:i.website,socialMedia:i.socialMedia,fax:i.fax,timestamp:i.timestamp,lastModified:i.lastModified}))};return{success:!0,data:JSON.stringify(a,null,2),count:e.length}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Failed to export cards"}}}}export{S as DeleteCardUseCase,b as DeleteMultipleCardsUseCase,T as ExportCardsUseCase,x as GetAllCardsUseCase,D as RescanCardUseCase,B as ScanBusinessCardUseCase,P as SearchCardsUseCase,v as UpdateCardUseCase};
